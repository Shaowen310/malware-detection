from keras.models import Model
from keras.layers import *
from keras.engine import Input


def MalNet(maxlen):

    main_input = Input(shape=(maxlen, ), dtype='int32', name='main_input')

    emb1 = Embedding(257, 8, input_length=maxlen, mask_zero=False)(main_input)
    conv1 = Convolution1D(128, 64, strides=64, padding='same')(emb1)
    # flat1 = Flatten()(conv1)
    # drop1 = Dropout(0.2)(conv1)

    emb2 = Embedding(257, 8, input_length=maxlen, mask_zero=False)(main_input)
    conv2 = Convolution1D(128, 64, strides=64, padding='same', activation='relu')(emb2)
    # flat2 = Flatten()(conv2)
    # drop2 = Dropout(0.2)(conv2)

    # x = Multiply()([drop1, drop2])
    x = Concatenate()([conv1, conv2])
    x = Activation('relu')(x)

    ## Original Implementation
    x = GlobalMaxPooling1D()(x)
    # x = MaxPooling1D(pool_size=8)(x)
    # x = Flatten()(x)
    x = Dense(128, activation='relu')(x)

    loss_out = Dense(1, activation='sigmoid', name='loss_out')(x)

    ## Migrate CNN
    # x = Flatten()(x)
    # x = Dropout(0.2)(x)
    # fc = Dense(128,activation='sigmoid', name='fc_1')(x)
    # fc = Dropout(0.2)(fc)
    # loss_out = Dense(1,activation='softmax')(fc)

    model = Model(outputs=[loss_out], inputs=[main_input])

    return model
